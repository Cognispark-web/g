<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Exam Paper Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            padding: 2.5rem;
            max-width: 28rem;
            width: 100%;
        }
        .button {
            transition: all 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .animate-pulse-slow {
            animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        /* Custom styles to prevent some browser actions */
        body {
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+ */
            user-select: none; /* Standard */
        }
        #watermark-canvas {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div class="container-card">

        <!-- Splash Screen / Home Section -->
        <div id="home-screen" class="space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800">Exam Paper Access</h1>
            <p class="text-center text-gray-600">Please select your school, class, and subject to proceed with payment.</p>

            <div class="space-y-4">
                <div>
                    <label for="school" class="block text-sm font-medium text-gray-700">School Name</label>
                    <select id="school" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150">
                        <option value="Chela Mary Memorial School Motihari">Chela Mary Memorial School Motihari</option>
                    </select>
                </div>

                <div>
                    <label for="class" class="block text-sm font-medium text-gray-700">Class</label>
                    <select id="class" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150">
                        <option value="10th Class">10th Class</option>
                    </select>
                </div>

                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700">Subject</label>
                    <select id="subject" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150">
                        <option value="English">English</option>
                        <!-- Other subjects will be added here in the future -->
                    </select>
                </div>
            </div>

            <button onclick="showPaymentScreen()" class="button w-full px-4 py-2 bg-indigo-600 text-white rounded-md shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Continue to Payment
            </button>
        </div>

        <!-- Payment Screen -->
        <div id="payment-screen" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-center text-gray-800">Proceed with Payment</h2>
            <p class="text-center text-gray-600">Click the button below to open your UPI app and pay. Please return to this page after completing the transaction.</p>

            <div class="bg-gray-100 p-6 rounded-lg text-center">
                <p class="text-sm text-gray-500 font-medium">UPI ID:</p>
                <p class="text-xl font-mono text-gray-900 mt-1">rk1260137@oksbi</p>
                <p class="text-sm text-gray-500 font-medium mt-2">Amount:</p>
                <p class="text-2xl font-bold text-gray-900 mt-1">₹109</p>
            </div>

            <button onclick="openUpiApp()" id="pay-button" class="button w-full px-4 py-2 bg-purple-600 text-white rounded-md shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                Pay Now (₹109)
            </button>
            <button onclick="initiateSecureAccess()" id="paid-button" class="button w-full px-4 py-2 bg-green-600 text-white rounded-md shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 hidden">
                I have paid
            </button>
        </div>

        <!-- Secure Access Countdown Screen -->
        <div id="countdown-screen" class="hidden text-center space-y-4">
            <h2 class="text-2xl font-bold text-gray-800">Accessing Your Content...</h2>
            <p class="text-gray-600">
                The content will be available in <span id="access-timer" class="font-bold text-indigo-600">2:00</span> minutes.
                <br>This is a highly secured page.
            </p>
            <div class="relative w-24 h-24 mx-auto">
                <div class="animate-spin rounded-full h-full w-full border-t-4 border-b-4 border-indigo-500"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <svg class="w-12 h-12 text-indigo-500 animate-pulse-slow" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM8 9a1 1 0 00-1 1v2a1 1 0 001 1h4a1 1 0 001-1v-2a1 1 0 00-1-1H8z" clip-rule="evenodd" fill-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Secure Image Viewing Screen -->
        <div id="secure-page" class="hidden space-y-4">
            <h2 class="text-2xl font-bold text-center text-gray-800">Your Exam Paper</h2>
            <p class="text-center text-red-500 font-medium">WARNING: This content is for viewing only. Any attempt to download or screenshot will be logged and your access will be revoked.</p>
            <p class="text-center text-gray-600">Time remaining: <span id="image-timer" class="font-bold text-indigo-600">10:00</span></p>

            <div class="flex items-center justify-center bg-gray-200 rounded-lg overflow-hidden relative" style="height: 400px;">
                <canvas id="watermark-canvas" class="w-full h-full object-contain"></canvas>
            </div>
            
        </div>

        <!-- Error/Expired Link Screen -->
        <div id="error-screen" class="hidden text-center space-y-4 p-6 bg-red-50 rounded-lg">
            <h2 class="text-2xl font-bold text-red-700">Access Denied</h2>
            <p class="text-red-600">This link is either invalid or has expired. Please restart the process from the home page.</p>
            <button onclick="resetApp()" class="button px-4 py-2 bg-red-600 text-white rounded-md shadow-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                Return to Home
            </button>
        </div>

        <!-- Pop-up message box -->
        <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm text-center space-y-4">
                <h3 class="text-lg font-bold text-gray-800">Warning</h3>
                <p id="message-text" class="text-gray-600">Message content.</p>
                <button onclick="hideMessage()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button>
            </div>
        </div>

    </div>

    <script>
        const Screens = {
            HOME: 'home-screen',
            PAYMENT: 'payment-screen',
            COUNTDOWN: 'countdown-screen',
            SECURE: 'secure-page',
            ERROR: 'error-screen'
        };

        const SECURE_ACCESS_TOKEN = 'secure_access_token';
        const ACCESS_TIMEOUT_MS = 2 * 60 * 1000; // 2 minutes
        const VIEWING_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes

        const imagePlaceholder = 'https://placehold.co/800x600/f8fafc/1f2937?text=Example+Exam+Paper';
        
        let watermarkInterval;
        let countdownInterval;
        let viewingTimeout;
        let imageTimerInterval;

        const showScreen = (screenId) => {
            Object.values(Screens).forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        };

        const showMessage = (message) => {
            document.getElementById('message-text').innerText = message;
            document.getElementById('message-box').classList.remove('hidden');
        };

        const hideMessage = () => {
            document.getElementById('message-box').classList.add('hidden');
        };

        const resetApp = () => {
            localStorage.removeItem(SECURE_ACCESS_TOKEN);
            showScreen(Screens.HOME);
            
            // Clear all intervals and timeouts
            clearInterval(watermarkInterval);
            clearInterval(countdownInterval);
            clearInterval(imageTimerInterval);
            clearTimeout(viewingTimeout);
        };

        const showPaymentScreen = () => {
            showScreen(Screens.PAYMENT);
        };

        const openUpiApp = () => {
            const upiId = 'rk1260137@oksbi';
            const amount = '109';
            const payeeName = 'Chela Mary Memorial School';
            const transactionRef = 'TXN' + Date.now(); // A simple unique transaction reference

            const upiLink = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(payeeName)}&am=${amount}&cu=INR&tid=${transactionRef}`;
            
            // Attempt to open the UPI app
            window.location.href = upiLink;

            // Hide the "Pay Now" button and show the "I have paid" button
            document.getElementById('pay-button').classList.add('hidden');
            document.getElementById('paid-button').classList.remove('hidden');

            showMessage("Redirecting to your UPI app. After payment, please come back to this page and click 'I have paid'.");
        };

        const initiateSecureAccess = () => {
            const token = {
                id: crypto.randomUUID(),
                expiry: Date.now() + ACCESS_TIMEOUT_MS + VIEWING_TIMEOUT_MS
            };
            localStorage.setItem(SECURE_ACCESS_TOKEN, JSON.stringify(token));
            showScreen(Screens.COUNTDOWN);
            startAccessCountdown();
        };

        const startAccessCountdown = () => {
            let timeLeft = ACCESS_TIMEOUT_MS / 1000;
            const timerElement = document.getElementById('access-timer');

            countdownInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.innerText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    checkSecureAccess();
                }
            }, 1000);
        };

        const checkSecureAccess = () => {
            const storedToken = localStorage.getItem(SECURE_ACCESS_TOKEN);
            if (!storedToken) {
                showScreen(Screens.ERROR);
                return;
            }

            const token = JSON.parse(storedToken);
            if (Date.now() > token.expiry) {
                localStorage.removeItem(SECURE_ACCESS_TOKEN);
                showScreen(Screens.ERROR);
            } else {
                showScreen(Screens.SECURE);
                startSecureViewing();
            }
        };

        const startSecureViewing = () => {
            const canvas = document.getElementById('watermark-canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                
                let watermarkX = 10;
                let watermarkY = 10;
                const watermarkText = "ChelaMaryMemorial.com - Do Not Copy";
                const watermarkColor = "rgba(0, 0, 0, 0.2)";
                const watermarkFont = "20px 'Inter', sans-serif";

                const drawWatermark = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);

                    ctx.font = watermarkFont;
                    ctx.fillStyle = watermarkColor;
                    ctx.textAlign = 'start';
                    ctx.textBaseline = 'top';

                    ctx.fillText(watermarkText, watermarkX, watermarkY);

                    watermarkX += Math.random() * 20 - 10;
                    watermarkY += Math.random() * 20 - 10;
                    if (watermarkX < 0) watermarkX = 0;
                    if (watermarkY < 0) watermarkY = 0;
                    if (watermarkX > canvas.width - ctx.measureText(watermarkText).width) watermarkX = canvas.width - ctx.measureText(watermarkText).width;
                    if (watermarkY > canvas.height - 20) watermarkY = canvas.height - 20;
                };

                watermarkInterval = setInterval(drawWatermark, 1000);
            };
            img.src = imagePlaceholder;

            // Start 10-minute viewing timer
            let timeLeft = VIEWING_TIMEOUT_MS / 1000;
            const timerElement = document.getElementById('image-timer');
            imageTimerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.innerText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);

            viewingTimeout = setTimeout(() => {
                showMessage("Your 10-minute viewing session has ended.");
                clearInterval(watermarkInterval);
                clearInterval(imageTimerInterval);
                const canvas = document.getElementById('watermark-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                showScreen(Screens.ERROR);
            }, VIEWING_TIMEOUT_MS);
        };

        // Event listeners to prevent common download/screenshot actions
        document.addEventListener('contextmenu', event => {
            event.preventDefault();
            showMessage("Right-click disabled for security reasons.");
        });

        document.addEventListener('keydown', event => {
            // Prevent Ctrl+S, Ctrl+P, and PrintScreen
            if ((event.ctrlKey || event.metaKey) && (event.key === 's' || event.key === 'p')) {
                event.preventDefault();
                showMessage("Action blocked: This content is protected.");
            }
        });

        window.addEventListener('load', () => {
            // Check if a secure access token exists and is valid on page load
            const storedToken = localStorage.getItem(SECURE_ACCESS_TOKEN);
            if (storedToken) {
                const token = JSON.parse(storedToken);
                if (Date.now() < token.expiry) {
                    // If the token is valid, immediately proceed to the secure page
                    showScreen(Screens.SECURE);
                    startSecureViewing();
                    const timeLeft = Math.floor((token.expiry - Date.now()) / 1000);
                    if (timeLeft > 0) {
                        document.getElementById('image-timer').innerText = `${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}`;
                    }
                } else {
                    localStorage.removeItem(SECURE_ACCESS_TOKEN);
                    showScreen(Screens.HOME); // Token expired, go to home screen
                }
            } else {
                showScreen(Screens.HOME);
            }
        });

    </script>
</body>
</html>
